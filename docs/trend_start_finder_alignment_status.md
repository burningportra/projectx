# ProjectX Trend Start Finder Alignment: Current Status & Next Steps

## 1. Goal

The primary objective is to align the 1-day trend start detection logic of `src/strategies/trend_start_finder.py` (used by `src/analysis/analyzer_service.py`) with an older script, `trend_analysis/trend_analyzer_alt.py`. The aim is for `trend_start_finder.py` to produce the same '1d' trend start signals (CUS - Confirmed Uptrend Start, CDS - Confirmed Downtrend Start) as `trend_analyzer_alt.py`.

## 2. Reference Data

*   **Old Script Output**: `trend_analysis/confirmed_trend_starts_1d-0521.csv` (16 signals for CON.F.US.MES.M25)
*   **New Script Output**: `logs/detected_signals_history.csv` (generated by `analyzer_service.py`)
*   **Debug Logs**: `logs/trend_finder_debug_cus_cds_trend_finder_CON.F.US.MES.M25_1d.csv` (detailed bar-by-bar log from `trend_start_finder.py`)

## 3. Key Differences Identified & Addressed in `trend_start_finder.py`

The core of the work has involved iteratively modifying `trend_start_finder.py` to mirror the logic of `trend_analyzer_alt.py`.

### 3.1. Strict Alternation and Forced Trends:
*   **Original `trend_analyzer_alt.py` behavior**:
    *   Strictly alternates between uptrend and downtrend signals.
    *   If two consecutive signals of the same type occurred, it "forced" an opposite trend in between.
*   **Modifications to `trend_start_finder.py`**:
    *   Implemented state variables (`overall_trend_is_up`, `last_confirmed_trend_type`, `last_confirmed_trend_bar_index`) to track and enforce alternation.
    *   Added logic to attempt to find/force an intervening opposite trend if a direct confirmation would violate alternation.

### 3.2. Potential Uptrend/Downtrend Start (PUS/PDS) Handling:
*   **Initial `trend_start_finder.py` behavior**: When a PDS was formed, it immediately cleared any existing PUS (and vice-versa).
*   **`trend_analyzer_alt.py` behavior**: Allowed PDS and PUS candidates to co-exist. They were only cleared upon a CUS/CDS *confirmation* or specific *invalidation* rules.
*   **Modifications to `trend_start_finder.py`**:
    *   The logic for immediate clearing of an opposing PUS/PDS upon formation of a new PDS/PUS was commented out. This allows PUS and PDS to co-exist until a confirmation or specific invalidation.

### 3.3. PUS/PDS Setting After CUS/CDS Confirmation:
*   **Initial `trend_start_finder.py` behavior**: The setting of a new PDS (Potential Downtrend Start) after a CUS (Confirmed Uptrend Start), and a new PUS after a CDS, had some conditional logic.
*   **`trend_analyzer_alt.py` behavior (inferred)**: Appears to always establish a new potential opposite trend start candidate immediately on the bar where a CUS/CDS is confirmed.
*   **Modifications to `trend_start_finder.py`**:
    *   Standardized the logic:
        *   After a CUS is confirmed on `cus_confirmed_on_bar_obj`, a new PDS candidate is *always* set using `cus_confirmed_on_bar_obj` as its anchor.
        *   After a CDS is confirmed on `cds_confirmed_on_bar_obj`, a new PUS candidate is *always* set using `cds_confirmed_on_bar_obj` as its anchor.
    *   **Crucially**, the consumed PUS/PDS state (the one that led to the CUS/CDS) needs to be explicitly cleared *after* the new opposite potential signal is set. Edits were made to ensure:
        *   `state.potential_uptrend_signal_bar_index` (and related PUS fields) are cleared *after* a CUS confirmation and *after* the new PDS is set.
        *   `state.potential_downtrend_signal_bar_index` (and related PDS fields) are cleared *after* a CDS confirmation and *after* the new PUS is set.

### 3.4. PUS/PDS Invalidation Logic:
*   **`trend_analyzer_alt.py` behavior**: Contained specific rules for invalidating a PUS or PDS. For example:
    *   A PDS (potential downtrend) would be invalidated if, during a confirmed uptrend, the market made a higher low than the PDS's anchor low.
    *   A PUS (potential uptrend) would be invalidated if, during a confirmed downtrend, the market made a lower high than the PUS's anchor high.
*   **Modifications to `trend_start_finder.py`**:
    *   This logic was initially commented out in `trend_start_finder.py` for simplification.
    *   It has now been re-instated (uncommented and verified) to match the old script's behavior more closely. This involves checking `current_bar.l` against `pds_candidate_bar_for_invalidation.l` during an uptrend, and `current_bar.h` against `pus_candidate_bar_for_invalidation.h` during a downtrend.

## 4. Current State of `trend_start_finder.py` (Post-Modifications)

The latest version of `src/strategies/trend_start_finder.py` includes:
*   State management for overall trend and last confirmed trend.
*   Strict alternation of CUS/CDS.
*   Logic to "force" an intermediate trend if necessary.
*   Co-existence of PUS and PDS until confirmation or invalidation.
*   Standardized setting of new PDS after CUS (on the CUS bar) and new PUS after CDS (on the CDS bar).
*   Explicit clearing of the *consumed* PUS/PDS *after* the new opposite potential signal has been established.
*   Active PUS/PDS invalidation rules (e.g., PDS invalidated by a higher low during an uptrend).

## 5. Debugging & Development Process Aids

*   **Detailed Debug Logging**: `trend_start_finder.py` generates extensive debug logs (dictionaries) that are written to `logs/trend_finder_debug_cus_cds_trend_finder_CON.F.US.MES.M25_1d.csv`. This CSV has been instrumental in tracing the script's state and decisions bar by bar.
*   **`analyzer_service.py` Modifications**:
    *   Adapted to handle and write the debug logs from `trend_start_finder.py`.
    *   Set to `ANALYZER_RESET_TARGET_DATA_ON_START: true` in `config/settings.yaml` to reprocess historical data from scratch on each run, ensuring clean test conditions.
    *   Focused on the '1d' timeframe for CON.F.US.MES.M25 during backlog processing for targeted debugging.
*   **Database Cleanup**: `psql` commands were used to clear `detected_signals` and `analyzer_watermarks` tables before test runs.

## 6. Last Known Discrepancy & Point of Investigation (Before this summary)

The last set of logs (`detected_signals_history.csv` and the debug CSV) showed:
*   **New Script Signals**: 11
*   **Old Script Signals**: 16
*   The divergence still started fairly early in the signal sequence.
*   A key area of focus was ensuring that when a CUS or CDS is confirmed, the *original* PUS or PDS that *led* to this confirmation is properly cleared from the state, specifically *after* the new opposing PDS/PUS has been established on the confirmation bar.

    The sequence should be:
    1.  CUS is confirmed (e.g., from an existing PUS).
    2.  A *new* PDS is established using the CUS confirmation bar.
    3.  The *original* PUS (that led to the CUS) is *then* cleared.
    4.  (Similarly for CDS leading to a new PUS, then clearing the original PDS).

    The last set of edits aimed to correctly order these clearing operations.

## 7. Next Steps for the Developer

1.  **Verify the Last Edits**:
    *   The most recent edits focused on the correct clearing of consumed PUS/PDS *after* a new PDS/PUS is set post-confirmation.
    *   The file content was:
        *   Inside CUS confirmation:
            ```python
            # ... (PDS candidate set using cus_confirmed_on_bar_obj) ...
            logger.info(f"{log_prefix}   ➡️ After Confirmed Uptrend Start: New Potential Downtrend Start on CUS Bar {cus_confirmed_on_bar_obj.index} (H:{cus_confirmed_on_bar_obj.h}, L:{cus_confirmed_on_bar_obj.l}) due to '{friendly_cus_rule_name_short}' rule.")
            # ... (debug log append for PDS_CANDIDATE_SET_POST_CUS) ...

            # NOW, clear the PUS that led to this CUS
            if original_cus_from_pus_bar_index is not None:
                logger.info(f"{log_prefix}     Clearing original PUS at Bar {original_cus_from_pus_bar_index} which led to this CUS.")
                debug_log_entries.append({**current_bar_log_base, "event_type": "PUS_CONSUMED_BY_CUS", "message": f"Original PUS at {original_cus_from_pus_bar_index} consumed by CUS.", "pus_bar_index": original_cus_from_pus_bar_index})
            state.potential_uptrend_signal_bar_index = None
            state.potential_uptrend_anchor_low = None
            state.confirmed_uptrend_candidate_low_bar_index = None
            state.confirmed_uptrend_candidate_low_low = None
            state.confirmed_uptrend_candidate_low_high = None
            ```
        *   Inside CDS confirmation:
            ```python
            # ... (PUS candidate set using cds_confirmed_on_bar_obj) ...
            logger.info(f"{log_prefix}   ⬅️ After Confirmed Downtrend Start: New Potential Uptrend Start on CDS Bar {cds_confirmed_on_bar_obj.index} (L:{cds_confirmed_on_bar_obj.l}, H:{cds_confirmed_on_bar_obj.h}) due to '{friendly_cds_rule_name_short}' rule.")
            # ... (debug log append for PUS_CANDIDATE_SET_POST_CDS) ...

            # NOW, clear the PDS that led to this CDS
            if original_cds_from_pds_bar_index is not None:
                logger.info(f"{log_prefix}     Clearing original PDS at Bar {original_cds_from_pds_bar_index} which led to this CDS.")
                debug_log_entries.append({**current_bar_log_base, "event_type": "PDS_CONSUMED_BY_CDS", "message": f"Original PDS at {original_cds_from_pds_bar_index} consumed by CDS.", "pds_bar_index": original_cds_from_pds_bar_index})
            state.potential_downtrend_signal_bar_index = None
            state.potential_downtrend_anchor_high = None
            state.confirmed_downtrend_candidate_peak_bar_index = None
            state.confirmed_downtrend_candidate_peak_high = None
            state.confirmed_downtrend_candidate_peak_low = None
            ```
    *   **Action**: Manually inspect `src/strategies/trend_start_finder.py` around lines 600-620 (for CUS block) and 710-730 (for CDS block) to confirm these specific clearing sections are present and correctly placed *after* the logging and debug appends for `PDS_CANDIDATE_SET_POST_CUS` and `PUS_CANDIDATE_SET_POST_CDS` respectively. The `tool_code` output indicated only partial success with the last edit attempt. The logging messages for the PDS/PUS set *after* CUS/CDS were updated, but the actual clearing of the *consumed* PUS/PDS might still be in the wrong place or incomplete.

2.  **Run the Analyzer**:
    *   Ensure `ANALYZER_RESET_TARGET_DATA_ON_START` is `true` in `config/settings.yaml`.
    *   Ensure `settings.yaml` is configured to process `CON.F.US.MES.M25` for the `1d` timeframe.
    *   Run `src/analysis/analyzer_service.py`.

3.  **Compare Outputs**:
    *   Compare `logs/detected_signals_history.csv` with `trend_analysis/confirmed_trend_starts_1d-0521.csv`.
    *   Pay close attention to the first few signals where divergence occurs.
    *   Examine `logs/trend_finder_debug_cus_cds_trend_finder_CON.F.US.MES.M25_1d.csv` at the bar indices corresponding to the discrepancies. Trace the state variables:
        *   `last_confirmed_trend_type`, `last_confirmed_trend_bar_index`
        *   `potential_uptrend_signal_bar_index`, `potential_uptrend_anchor_low`
        *   `potential_downtrend_signal_bar_index`, `potential_downtrend_anchor_high`
        *   `confirmed_uptrend_candidate_...`
        *   `confirmed_downtrend_candidate_...`
        *   `overall_trend_is_up`
        *   Event types like `PUS_CONSUMED_BY_CUS`, `PDS_CONSUMED_BY_CDS`.

4.  **Hypothesize and Adjust**:
    *   Based on the debug log, if the state clearing isn't happening as expected, or if PUS/PDS invalidation rules are triggering differently, formulate a hypothesis.
    *   For instance, if an old PUS is still present after a CUS and a new PDS is formed, it might interfere with the next CDS formation.
    *   The "forcing logic" might also be a point of difference if the conditions leading up to a forced trend are not aligning. The debug logs for `FORCE_DOWNTREND_ATTEMPT` or `FORCE_UPTREND_ATTEMPT` and their outcomes (`FORCED_CDS_CONFIRMED`, `FORCED_CUS_CONFIRMED`, or failures) will be key.

5.  **Iterate**: Modify `trend_start_finder.py` based on the hypothesis, re-run, and re-compare.

If the developer needs to review the original logic, `trend_analysis/trend_analyzer_alt.py` is the reference script.

The primary remaining suspect is the precise moment and conditions under which the PUS/PDS that *led* to a CUS/CDS are cleared from the state, ensuring they don't erroneously influence subsequent signal detection. 
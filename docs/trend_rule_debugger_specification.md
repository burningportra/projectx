# Trend Rule Debugger & Developer Tool Specification

## 1. Overview

This document outlines the specification for a "Trend Rule Debugger/Developer Tool." The primary purpose of this tool is to assist in the analysis of discrepancies between expected trend start signals (Confirmed Uptrend Starts - CUS, Confirmed Downtrend Starts - CDS) and the signals generated by the `trend_analyzer_alt.py` script. It will provide a focused environment to understand why specific rules fire or fail to fire in given historical scenarios, thereby facilitating rule refinement and the creation of new rules.

## 2. Core Objectives

*   **Discrepancy Analysis:** Allow a developer to pinpoint why the main analyzer might have missed an expected trend start (false negative) or identified an incorrect one (false positive) in a specific historical context.
*   **Rule Behavior Insight:** Provide detailed insight into which CUS/CDS confirmation rules were evaluated and what their outcomes were for a specific, small segment of price data.
*   **Facilitate Rule Refinement:** Enable developers to test modifications to existing rules or prototype new rules by observing their behavior on isolated historical examples.
*   **Iterative Development:** Support an iterative workflow where a developer can define a scenario, observe behavior, adjust rules (in the main analyzer or a test version), and re-observe.

## 3. Key Features

### 3.1. Input-Driven Scenario Definition

The tool will be driven by user-defined scenarios. For each scenario, the user will provide:

*   **`ohlc_data_file`**: Path to the OHLC data CSV file (e.g., `data/CON.F.US.MES.M25_4h_ohlc.csv`).
*   **`expected_trend_type`**: The type of trend start expected (e.g., "CUS" or "CDS").
*   **`trend_start_event_bar_index`**: The 1-based chronological index of the bar that constitutes the *Pending* Trend Start (PUS or PDS) for the expected trend.
*   **`trend_confirmation_bar_index`**: The 1-based chronological index of the bar where the `expected_trend_type` is *confirmed*.
*   **`context_bars_before` (Optional)**: Number of bars to load *before* the `trend_start_event_bar_index` to provide context (e.g., default to 10).
*   **`context_bars_after` (Optional)**: Number of bars to load *after* the `trend_confirmation_bar_index` for context (e.g., default to 5).

### 3.2. Focused Analysis Engine

*   **Data Slicing:** The tool will load only the relevant slice of OHLC data from the specified file, based on the `trend_start_event_bar_index`, `trend_confirmation_bar_index`, and context bars.
*   **Targeted Logic Execution:** It will run the core trend detection logic (potentially a simplified or adapted version of `process_trend_logic` and rule evaluation functions from `trend_analyzer_alt.py`) *only* on this data slice.
*   **State Priming (Optional):** Consideration should be given to how the initial `State` object is primed for the analysis of the slice. It might start neutral, or the user could specify some initial state conditions if necessary for complex scenarios.

### 3.3. Detailed Output & Logging

For each bar processed within the defined slice (especially from the PUS/PDS event bar up to and including the confirmation bar):

*   **Bar Data:** Log the OHLC data of the `current_bar` and `prev_bar`.
*   **State Snapshot:** Log the complete state of the `State` object *before* rule evaluations for the `current_bar`.
*   **PUS/PDS Candidate Info:** Clearly log the details of `initial_pus_candidate_bar_obj` and `initial_pds_candidate_bar_obj` being considered.
*   **CUS Rule Evaluation Log:**
    *   For each CUS rule in `CUS_RULE_DEFINITIONS`:
        *   Log that the rule is being evaluated.
        *   Log the outcome (True/False).
        *   If True, log it as the CUS trigger.
*   **CDS Rule Evaluation Log:**
    *   For each CDS rule in `CDS_RULE_DEFINITIONS`:
        *   Log that the rule is being evaluated.
        *   Log the outcome (True/False).
        *   If True, log it as the CDS trigger.
*   **Confirmation Outcome:**
    *   Clearly state if a CUS or CDS was confirmed for the `current_bar`.
    *   If a CUS/CDS was confirmed:
        *   State which rule triggered it.
        *   Compare this to the `expected_trend_type` and `trend_confirmation_bar_index`.
        *   Highlight if the confirmed trend matches the expected one at the expected bar.
        *   Highlight if a different trend was confirmed, or if the expected trend was confirmed by an unexpected rule.
    *   If no trend was confirmed, and the `current_bar` *is* the `trend_confirmation_bar_index` for an `expected_trend_type`, highlight this as a potential false negative scenario.
*   **Final State Snapshot:** Log the state of the `State` object *after* all logic for the `current_bar` has run.

### 3.4. Output Format

*   **Console Output:** Human-readable, well-formatted log messages to the console.
*   **File Output (Optional):** Option to write the detailed log to a file for later review.
*   **Data Slice Export (Optional):** Option to export the exact OHLC slice used for the analysis to a temporary CSV file. This can help in manually reviewing the data or using it in other tools.

## 4. Implementation Approach

*   **New Script:** Develop this tool as a new Python script (e.g., `trend_rule_debugger.py`) located in the `trend_analysis/` or `scripts/` directory.
*   **Reuse Existing Logic:** Import and reuse classes (`Bar`, `State`) and functions (rule definitions, CUS/CDS evaluation logic) from `trend_analyzer_alt.py` as much as possible to ensure consistency. The debugger might use copies or slightly adapted versions of these for focused logging.
*   **Command-Line Interface:** Use `argparse` or a similar library to accept the scenario definition parameters.

## 5. Example Workflow

1.  **Identify Discrepancy:** User notices that `trend_analyzer_alt.py` missed an expected CUS at bar #150, which was from a PUS at bar #145.
2.  **Invoke Debugger:**
    \`\`\`bash
    python trend_rule_debugger.py \\
        --ohlc_data_file data/CON.F.US.MES.M25_4h_ohlc.csv \\
        --expected_trend_type CUS \\
        --trend_start_event_bar_index 145 \\
        --trend_confirmation_bar_index 150 \\
        --context_bars_before 5 \\
        --context_bars_after 3
    \`\`\`
3.  **Analyze Output:** The user reviews the detailed log for bars 140 through 153. They focus on bar #150 to see:
    *   The state of PUS/PDS candidates.
    *   Which CUS rules were checked.
    *   Why none of them (or the wrong one) fired.
4.  **Refine Rule:** Based on the analysis, the user identifies a condition in an existing CUS rule that needs adjustment or decides a new rule is needed.
5.  **Test Refinement:** The user modifies the rule in `trend_analyzer_alt.py` (or a copy used by the debugger).
6.  **Re-run Debugger:** The user re-runs the debugger with the same parameters to see if the change produces the expected outcome for that specific scenario.
7.  **Iterate:** Repeat steps 3-6 until the rule behaves as expected for the scenario.
8.  **Full Validation:** After refining rules with the debugger, run the full `trend_analyzer_alt.py` on the entire dataset to check for unintended consequences.

## 6. Future Enhancements (Optional)

*   **Rule Parameterization:** Allow temporary overriding of rule parameters directly from the debugger's command line for quick "what-if" analysis.
*   **Visual Output:** Simple text-based chart of the price action in the slice.
*   **Integration with Test Framework:** Define scenarios as test cases that the debugger can run automatically.

This specification provides a foundation for building a valuable tool for the ongoing development and refinement of the trend detection logic. 